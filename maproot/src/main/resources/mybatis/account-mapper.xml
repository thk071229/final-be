<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="account">

	<!-- 회원가입 -->
	<insert id="insert">
		insert into account(
			account_id, account_pw, account_nickname, 
			account_birth, account_contact, account_email, 
			account_gender
			) 
		values(
			#{accountId}, #{accountPw}, #{accountNickname}, 
			#{accountBirth}, #{accountContact}, #{accountEmail}, 
			#{accountGender}
			)
	</insert>
	
	<!-- 회원프로필 -->
	<insert id="connect">
		insert into account_profile(account_id, attachment_no) 
		values(
		#{accountId}, #{attachmentNo}
		)
	</insert>
	<select id="findAttach" resultType="long">
		select attachment_no from account_profile 
		where account_id = #{accountId}
	</select>
	
	<!-- 중복검사 -->
	<select id="countByAccountId" resultType="int">
		select count(*) from account where account_id = #{accountId}
	</select>
	
	<select id="countByAccountNickname" resultType="int">
		select count(*) from account where account_nickname = #{accountNickname}
	</select>
	
	<select id="countByAccountContact" resultType="int">
		select count(*) from account where account_contact = #{accountContact}
	</select>
	
	<select id="countByAccountEmail" resultType="int">
		select count(*) from account where account_email = #{accountEmail}
	</select>
	
	<!-- Paging을 위한 Count -->
	<select id="count" resultType="int">
		select count(*) from account
	</select>
	
	<!-- 회원의 로그인 시간 업데이트 -->
	<update id="updateLoginTime">
		update account 
		set 
		account_login = systimestamp 
		where account_id = #{accountId}
	</update>
	
	<!-- 회원 정보 업데이트(PATCH) -->
	<update id="update">
		update account 
		<set>
			<if test="accountNickname != null and accountNickname != ''">
				account_nickname = #{accountNickname}, 
			</if>
			<if test="accountEmail != null and accountEmail != ''">
				account_email = #{accountEmail}, 
			</if>
			<if test="accountBirth != null and accountBirth != ''">
				account_birth = #{accountBirth}, 
			</if>
			<if test="accountGender != null and accountGender != ''">
				account_gender = #{accountGender}, 
			</if>
			account_change = systimestamp 
		</set>
		where account_id = #{accountId}
	</update>
	
	<!-- 회원 정보 업데이트(PATCH) -->
	<update id="updatePw">
		update account
			set 
			account_pw = #{accountPw}, account_change = systimestamp 
		where account_id = #{accountId}
	</update>
	
	<update id="updateContact">
		update account 
			set 
			account_contact = #{accountContact}, account_change = systimestamp
		where account_id = #{accountId}
	</update>
	
	<!-- 회원 삭제 -->
	<delete id="delete">
		delete from account where account_id = #{accountId}
	</delete>
	
	<!-- 회원 상세 조회 -->
	<select id="detail" resultType="AccountDto">
		select * from account where account_id = #{accountId}
	</select>
	<select id="detailByAccountNickname" resultType="AccountDto">
		select * from account where account_nickname = #{accountNickname}
	</select>
	
	<!-- 회원 검색 -->
	
	
	<!-- 관리자용 복합검색 -->
	<sql id="accountSearch">
	    <where>
	        <if test="accountComplexSearchVO.accountId != null">
	            AND instr(A.account_id, #{accountComplexSearchVO.accountId}) > 0 
	        </if>
	        <if test="accountComplexSearchVO.accountNickname != null">
	            AND instr(A.account_nickname, #{accountComplexSearchVO.accountNickname}) > 0 
	        </if>
	        <if test="accountComplexSearchVO.accountEmail != null">
	            AND instr(A.account_email, #{accountComplexSearchVO.accountEmail}) > 0 
	        </if>
	        <if test="accountComplexSearchVO.accountContact != null">
	            AND A.account_contact LIKE #{accountComplexSearchVO.accountContact} || '%' 
	        </if>
	        <if test="accountComplexSearchVO.accountBirth != null">
	            AND A.account_birth = #{accountComplexSearchVO.accountBirth}
	        </if>
	        
	        <choose>
	            <when test="accountComplexSearchVO.beginAccountJoin != null and accountComplexSearchVO.endAccountJoin != null">
	                AND A.account_join BETWEEN 
	                    to_timestamp(#{accountComplexSearchVO.beginAccountJoin} || ' 00:00:00.000', 'yyyy-mm-dd hh24:mi:ss.ff3') 
	                    AND 
	                    to_timestamp(#{accountComplexSearchVO.endAccountJoin} || ' 23:59:59.999', 'yyyy-mm-dd hh24:mi:ss.ff3')
	            </when>
	            <when test="accountComplexSearchVO.beginAccountJoin != null">
	                AND A.account_join <![CDATA[ >= ]]> to_timestamp(#{accountComplexSearchVO.beginAccountJoin} || ' 00:00:00.000', 'yyyy-mm-dd hh24:mi:ss.ff3')
	            </when>
	            <when test="accountComplexSearchVO.endAccountJoin != null">
	                AND A.account_join <![CDATA[ <= ]]> to_timestamp(#{accountComplexSearchVO.endAccountJoin} || ' 23:59:59.999', 'yyyy-mm-dd hh24:mi:ss.ff3')
	            </when>
	        </choose>
	
	        <choose>
	            <when test="accountComplexSearchVO.minSchedule != null and accountComplexSearchVO.maxSchedule != null">
	                AND A.account_max_schedule BETWEEN #{accountComplexSearchVO.minSchedule} AND #{accountComplexSearchVO.maxSchedule} 
	            </when>
	            <when test="accountComplexSearchVO.minSchedule != null">
	                AND A.account_max_schedule <![CDATA[ >= ]]> #{accountComplexSearchVO.minSchedule}
	            </when>
	            <when test="accountComplexSearchVO.maxSchedule != null">
	                AND A.account_max_schedule <![CDATA[ <= ]]> #{accountComplexSearchVO.maxSchedule}
	            </when>
	        </choose>
	
	        <if test="accountComplexSearchVO.minScheduleCount != null">
	            AND (SELECT COUNT(*) FROM schedule S WHERE S.schedule_owner = A.account_id) <![CDATA[ >= ]]> #{accountComplexSearchVO.minScheduleCount}
	        </if>
	        <if test="accountComplexSearchVO.maxScheduleCount != null">
	            AND (SELECT COUNT(*) FROM schedule S WHERE S.schedule_owner = A.account_id) <![CDATA[ <= ]]> #{accountComplexSearchVO.maxScheduleCount}
	        </if>
	        <if test="accountComplexSearchVO.accountLevelList != null and accountComplexSearchVO.accountLevelList.size() > 0">
				<!-- item(변수명), collection(저장소), separator(구분자) -->
				<foreach collection="accountComplexSearchVO.accountLevelList" item="accountLevel"
									separator="," open="and account_level in (" close=")">
					#{accountLevel}
				</foreach>
 			</if>
	    </where>
	</sql>
	
	<select id="complexSearch" resultType="AccountForAdminVO">
	    SELECT * FROM (
	        SELECT ROWNUM AS rn, TMP.* FROM (
	            SELECT 
	                A.account_id, A.account_nickname, A.account_email,
	                A.account_contact, A.account_level, A.account_join,
	                A.account_login, A.account_max_schedule, A.account_birth,
	                (SELECT COUNT(*) FROM schedule S WHERE S.schedule_owner = A.account_id) AS schedule_count
	            FROM account A
	            <include refid="accountSearch" />
	            ORDER BY A.account_join DESC
	        ) TMP
	        WHERE ROWNUM <![CDATA[ <= ]]> #{end}
	    ) WHERE rn <![CDATA[ >= ]]> #{begin}
	</select>
	
	<select id="countComplexSearch" resultType="int">
	    SELECT COUNT(*) FROM account A
	    <include refid="accountSearch" />
	</select>
	
	<!-- 아이디 찾기(휴대폰, 이메일) -->
	<select id="findAccountId" resultType="String">
		select account_id from account 
		where 
		<choose>
			<when test="accountContact != null">
				account_contact = #{accountContact}
			</when>
			<when test="accountEmail != null">
				account_email = #{accountEmail}
			</when>
		
		</choose>
	</select>
	
	<!-- 카카오페이 관련 -->
	<select id="originMaxSchedule" resultType="AccountDto">
		select account_max_schedule from account where account_id = #{accountId}
	</select>
	
	<update id="updateMaxSchedule">
		update account set account_max_schedule = #{accountMaxSchedule} where account_id = #{accountId}
	</update>
	
	<select id="selectAccountDashboardList" resultType="AccountForAdminVO">
	    SELECT * FROM (
	        SELECT ROWNUM AS rn, TMP.* FROM (
	            SELECT 
	                A.account_id,
	                A.account_nickname,
	                A.account_email,
	                A.account_contact,
	                A.account_level,
	                A.account_join,
	                A.account_login,
	                A.account_max_schedule,
	                (SELECT COUNT(*) 
	                 FROM schedule S 
	                 WHERE S.schedule_owner = A.account_id) AS schedule_count
	            FROM 
	                account A
	            ORDER BY 
	                A.account_join DESC
	        ) TMP
	        WHERE ROWNUM <![CDATA[ <= ]]> #{end}
	    ) WHERE rn <![CDATA[ >= ]]> #{begin}
	</select>

</mapper>