<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="schedule">

	<select id="sequence" resultType="long">
		select schedule_seq.nextval from dual
	</select>
	
	<insert id="insert">
		insert into schedule(
			schedule_no, schedule_name, 
			schedule_owner,schedule_start_date
			<if test="scheduleEndDate != null">
			,schedule_end_date    
			</if>
		) values(
			#{scheduleNo}, #{scheduleName},
			#{scheduleOwner}, #{scheduleStartDate}
			<if test="scheduleEndDate != null">
			,#{scheduleEndDate}
			</if>
		)
	</insert>
	
	<select id="selectByScheduleNo" resultType="ScheduleDto">
		select * from schedule where schedule_no = #{scheduleNo}
	</select>
	
	<update id="updateUnit">
		update schedule
			<set>
				<if test="scheduleName != null">
					schedule_name = #{scheduleName},
				</if>
				<if test="scheduleLike != null">
					schedule_like = #{scheduleLike},
				</if>
				<if test="scheduleView != null">
					schedule_view = #{scheduleView},
				</if>
				<if test="scheduleOwner != null">
					schedule_owner = #{scheduleOwner},
				</if>
				<if test="schedulePublic != null">
					schedule_public = #{schedulePublic},
				</if>
				<if test="scheduleState != null">
					schedule_state = #{scheduleState},
				</if>
				<if test="scheduleStartDate != null">
					schedule_start_date = #{scheduleStartDate},
				</if>
				<if test="scheduleEndDate != null">
					schedule_end_date = #{scheduleEndDate},
				</if>
				schedule_etime = systimestamp
			</set>
		where schedule_no = #{scheduleNo}
	</update>
	
	<!-- 일정 대표이미지 -->
	<insert id="connect">
		insert into schedule_profile(schedule_no, attachment_no) 
		values(
			#{scheduleNo}, #{attachmentNo}
		)
	</insert>
	<select id="findAttach" resultType="long">
		select attachment_no from schedule_profile 
		where schedule_no = #{scheduleNo}
	</select>
	
	<!-- 공개된 전체 일정 -->
	<select id="selectAllList" resultType="ScheduleDto">
		select * from schedule 
		where schedule_public = 'Y' order by schedule_no desc
	</select>
	<!-- 관리자용 전체 일정 -->
	<select id="selectAllListForAdmin" resultType="ScheduleDto">
		select * from schedule 
		order by schedule_no desc
	</select>
	
	
	<select id="countForSearch" resultType="int">
	    SELECT count(*) FROM schedule
	    <where>
	        <if test="search.keyword != null and search.keyword != ''">
	            AND (schedule_name LIKE '%' || #{search.keyword} || '%' 
	                 OR schedule_owner LIKE '%' || #{search.keyword} || '%')
	        </if>
	        <if test="search.schedulePublic != null and search.schedulePublic != 'ALL'">
	            AND schedule_public = #{search.schedulePublic}
	        </if>
	    </where>
	</select>
	
	<select id="selectListForSearch" resultType="ScheduleDto">
	    SELECT * FROM (
	        SELECT rownum rn, tmp.* FROM (
	            SELECT * FROM schedule
	            <where>
	                <if test="search.keyword != null and search.keyword != ''">
	                    AND (schedule_name LIKE '%' || #{search.keyword} || '%' 
	                         OR schedule_owner LIKE '%' || #{search.keyword} || '%')
	                </if>
	                <if test="search.schedulePublic != null and search.schedulePublic != 'ALL'">
	                    AND schedule_public = #{search.schedulePublic}
	                </if>
	            </where>
	            ORDER BY schedule_no DESC
	        ) tmp
	    ) 
	    WHERE rn BETWEEN #{page.begin} AND #{page.end}
	</select>



</mapper>