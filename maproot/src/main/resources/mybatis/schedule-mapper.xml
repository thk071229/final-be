<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="schedule">

	<select id="sequence" resultType="long">
		select schedule_seq.nextval from dual
	</select>
	
	<insert id="insert">
		insert into schedule(
			schedule_no, schedule_name, schedule_public, 
			schedule_owner,schedule_start_date
			<if test="scheduleEndDate != null">
			,schedule_end_date    
			</if>
		) values(
			#{scheduleNo}, #{scheduleName}, #{schedulePublic}, 
			#{scheduleOwner}, #{scheduleStartDate}
			<if test="scheduleEndDate != null">
			,#{scheduleEndDate}
			</if>
		)
	</insert>
	
	<select id="selectByScheduleNo" resultType="ScheduleDto">
		select * from schedule where schedule_no = #{scheduleNo}
	</select>
	
	<update id="updateUnit">
		update schedule
			<set>
				<if test="scheduleName != null">
					schedule_name = #{scheduleName},
				</if>
				<if test="scheduleLike != null">
					schedule_like = #{scheduleLike},
				</if>
				<if test="scheduleView != null">
					schedule_view = #{scheduleView},
				</if>
				<if test="scheduleOwner != null">
					schedule_owner = #{scheduleOwner},
				</if>
				<if test="schedulePublic != null">
					schedule_public = #{schedulePublic},
				</if>
				<if test="scheduleState != null">
					schedule_state = #{scheduleState},
				</if>
				<if test="scheduleStartDate != null">
					schedule_start_date = #{scheduleStartDate},
				</if>
				<if test="scheduleEndDate != null">
					schedule_end_date = #{scheduleEndDate},
				</if>
				schedule_etime = systimestamp
			</set>
		where schedule_no = #{scheduleNo}
	</update>
	
	<!-- 일정 대표이미지 -->
	<insert id="connect">
		insert into schedule_profile(schedule_no, attachment_no) 
		values(
			#{scheduleNo}, #{attachmentNo}
		)
	</insert>
	<select id="findAttach" resultType="long">
		select attachment_no from schedule_profile 
		where schedule_no = #{scheduleNo}
	</select>
	
	<select id="selectScheduleList" resultType="ScheduleListResponseVO">
    SELECT 
        S.schedule_no, 
        S.schedule_name, 
        CASE 
            WHEN SYSDATE &lt; S.schedule_start_date THEN '약속전'
            WHEN SYSDATE &gt; S.schedule_end_date THEN '종료'
            ELSE '진행중'
        END AS scheduleState,   
        S.schedule_public, 
        S.schedule_start_date, 
        S.schedule_end_date, 
        S.schedule_owner,
        SP.attachment_no as scheduleImage,
        (SELECT count(*) FROM schedule_member M WHERE M.schedule_no = S.schedule_no) as memberCount, 
        (SELECT count(*) FROM schedule_unit U WHERE U.schedule_no = S.schedule_no) as unitCount, 
        
        <!-- [추가] 해당 일정의 총 좋아요 수 -->
        (SELECT count(*) FROM account_like WHERE schedule_no = S.schedule_no) as scheduleLikeCount,
        
        <!-- [추가] 현재 로그인한 사용자의 좋아요 여부 -->
        <choose>
            <when test="loginId != null and loginId != ''">
                (SELECT count(*) FROM account_like 
                 WHERE schedule_no = S.schedule_no AND account_id = #{loginId}) as isLiked
            </when>
            <otherwise>
                0 as isLiked
            </otherwise>
        </choose>, <!-- 여기에 쉼표(,)가 누락되어 에러가 발생했습니다 -->

        U.schedule_unit_content as unitFirst,
        T.tags
    FROM schedule S 
    <if test="accountId != null and accountId != ''">
        JOIN schedule_member SM ON S.schedule_no = SM.schedule_no
    </if>
    LEFT JOIN schedule_profile SP ON S.schedule_no = SP.schedule_no 
    LEFT JOIN (
        SELECT schedule_no, schedule_unit_content
        FROM (
            SELECT schedule_no, schedule_unit_content,
                   ROW_NUMBER() OVER(PARTITION BY schedule_no ORDER BY schedule_unit_no ASC) as rn
            FROM schedule_unit
        )
        WHERE rn = 1
    ) U ON S.schedule_no = U.schedule_no
    LEFT JOIN (
        SELECT schedule_no, 
               LISTAGG(tag_name, ',') WITHIN GROUP (ORDER BY tag_name) as tags
        FROM schedule_tag
        GROUP BY schedule_no
    ) T ON S.schedule_no = T.schedule_no
    <where>
        <!-- Case 1: 내 일정 보기 -->
        <if test="accountId != null and accountId != ''">
            AND SM.account_id = #{accountId}
        </if>
        
        <!-- Case 2: 전체 공개 일정 보기 -->
        <if test="accountId == null or accountId == ''">
            AND S.schedule_public = 'Y'
            AND S.schedule_end_date &lt; SYSDATE
        </if>
    </where>
    ORDER BY S.schedule_no DESC
</select>
    
	<select id="selectByOwner" resultType="ScheduleDto">
		select * from schedule
		where schedule_owner = #{scheduleOwner}
	</select>
	
	<!-- 공개된 전체 일정 -->
	<select id="selectAllList" resultType="ScheduleDto">
		select * from schedule 
		where schedule_public = 'Y' order by schedule_no desc
	</select>
	<!-- 관리자용 전체 일정 -->
	<select id="selectAllListForAdmin" resultType="ScheduleDto">
		select * from schedule 
		order by schedule_no desc
	</select>
	
	
	<select id="countForSearch" resultType="int">
	    SELECT count(*) FROM schedule
	    <where>
	        <if test="search.keyword != null and search.keyword != ''">
	            AND (schedule_name LIKE '%' || #{search.keyword} || '%' 
	                 OR schedule_owner LIKE '%' || #{search.keyword} || '%')
	        </if>
	        <if test="search.schedulePublic != null and search.schedulePublic != 'ALL'">
	            AND schedule_public = #{search.schedulePublic}
	        </if>
	    </where>
	</select>
	
	<select id="selectListForSearch" resultType="ScheduleDto">
	    SELECT * FROM (
	        SELECT rownum rn, tmp.* FROM (
	            SELECT * FROM schedule
	            <where>
	                <if test="search.keyword != null and search.keyword != ''">
	                    AND (schedule_name LIKE '%' || #{search.keyword} || '%' 
	                         OR schedule_owner LIKE '%' || #{search.keyword} || '%')
	                </if>
	                <if test="search.schedulePublic != null and search.schedulePublic != 'ALL'">
	                    AND schedule_public = #{search.schedulePublic}
	                </if>
	            </where>
	            ORDER BY schedule_no DESC
	        ) tmp
	    ) 
	    WHERE rn BETWEEN #{page.begin} AND #{page.end}
	</select>

<update id="updateSchedulePublic">
  update schedule
  set schedule_public = #{schedulePublic}
  where schedule_no = #{scheduleNo}
</update>

  <update id="updateScheduleState">
    update schedule
    set schedule_state = #{scheduleState}
    where schedule_no = #{scheduleNo}
  </update>
	
	<delete id="delete">
		delete from schedule where schedule_no = #{scheduleNo}
	</delete>


</mapper>